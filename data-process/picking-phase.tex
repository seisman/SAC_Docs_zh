\section{震相拾取}
\label{sec:phase-picking}
相关命令：\nameref{cmd:plotpk}

震相拾取，或者说标定到时，是SAC的一种常用功能。

\subsection{ppk模式的进入与退出}
要进行震相拾取，首先要进入``ppk模式''。

读取波形数据后，在终端中键入 \nameref{cmd:plotpk}(简写为 \texttt{ppk})，
就会出现一个绘图窗口。若之前未曾打开过绘图窗口，则此时焦点位于ppk打开的绘图窗口
中；若之前曾经打开过绘图窗口，则需要鼠标点击一下绘图窗口以使得焦点位于绘图窗口
而不是终端中。此时，SAC就进入了``ppk模式''，终端中光标所在行没有SAC
提示符``\texttt{SAC>}''。

\begin{SACCode}
SAC> fg seis
SAC> ppk    // 焦点位于绘图窗口中，进入ppk模式
            // 光标所在行没有提示符"SAC> "
\end{SACCode}

学会如何进入ppk模式后，还要学会退出ppk模式。首先，确保焦点位于绘图窗口而不是终端，
然后将光标移动到绘图窗口中，按下``\texttt{q}''键即可退出ppk模式。此时，终端中光标所在行
会重新出现SAC提示符``\texttt{SAC>}''。

\begin{note}
只有当使用了ppk命令，焦点位于当前绘图窗口，且鼠标位于当前绘图窗口内才称为ppk模式。
在ppk模式下，所有的键盘输入都会被解释为"ppk命令"，但不会在终端中显示出来。
若使用ppk命令后，不慎使焦点位于终端内，即脱离了ppk模式，此时所有的键盘输入都会
出现在终端中，但不会被SAC解释，当退出ppk模式时，SAC才会依次解释终端中的命令。
\end{note}

\subsection{ppk模式下拾取震相}
下面介绍如何在ppk模式中拾取震相。先进入ppk模式，此时焦点位于绘图窗口，
并保证鼠标位于绘图区(即四个边框)的内部，移动鼠标到要标记到时的地方，
依次按下``\texttt{t}''、``\texttt{0}''，在要标记的到时处会出现一条竖线，
旁边有标识``\texttt{T0}''，此时已经将要标记的到时
(即竖线对应的X轴位置)保存到头段变量 \texttt{T0} 中。再按下``\texttt{q}''以退出ppk模式，
最后在终端键入``\texttt{wh}''将内存中的头段变量写回到磁盘文件中。

除了可以键入``\texttt{t}''和``\texttt{0}''之外，0还可以用1到9的任意数字替换，分别表示
将要标记的到时保存到T0到T9中。

\begin{SACCode}
SAC> fg seis
SAC> ppk
// 键入"t"和"0"标记到时，然后按"q"退出ppk模式
SAC> lh t0
     t0 = 1.255385e+01
SAC> wh         // 保存头段
\end{SACCode}

\begin{note}
在键入"t"时，鼠标不仅要在绘图窗口内，还要在绘图区(即四个边框)的内部，否则会
得到"Bad cursor position. Please retry."的错误提示。
\end{note}

\begin{note}
SAC全局变量 \verb|SAC_PPK_USE_CROSSHAIRS| 可以控制ppk模式下鼠标在绘图
窗口内的形态。若其值为 \texttt{0}，则鼠标会以十字线的形式出现，即
``{\Large$+$}''；当其值为 \texttt{1} 时，会在十字线的基础上加上水平线
和垂直线。通常建议设置其值为 \texttt{1}，使得拾取到时时更精确。该全局
变量的设置方式参考 \nameref{sec:sac-install-for-linux} 一节。
\end{note}

\subsection{qdp off}
SAC在默认情况下会打开快速绘图选项，即 \texttt{qdp on}。关于 \texttt{qdp}，可以
参考``\nameref{sec:plot-appearance}''一节以及命令 \nameref{cmd:qdp} 的说明。

在拾取震相时，若打开了快速绘图选项，则由于数据没有完全绘制而导致震相的可
识别度降低，也导致波形拾取精度降低。为了提高拾取精度，通常会在进入ppk模式
前关闭快速绘图选项，即使用 \texttt{qdp off} 命令：
\begin{SACCode}
SAC> dg sub reg elk.z
SAC> qdp on     // 打开快速绘图选项(默认值)
SAC> ppk
SAC> qdp off    // 关闭快速绘图选项
SAC> ppk        // 注意观察与之前的区别
\end{SACCode}
每次启动SAC后进入ppk模式前，都要手动执行 \texttt{qdp off} 以关闭快速绘图选项，
这样相对比较麻烦，可以使用``\nameref{sec:init-macro}''一节中介绍的方法使得
每次SAC启动时自动关闭快速绘图选项。

\subsection{放大与缩小}
有时数据时间较长，难以精确标定到时，此时需要将图幅放大，以显示整个波形的一小部分。

首先需要将光标移动到绘图区域中的某位置，键入``\texttt{x}''，
再移动至另一位置，再次键入``\texttt{x}''。这样，两次键入确定了一个时间窗。
这时，绘图窗口中将只显示该时间窗内的波形，也就实现了图幅的放大。
可不断重复此步骤，进行多次放大。

SAC 101.5之后的版本有更方便的方式：在绘图窗口中某位置按下鼠标左键，
并拖动至另一位置再松开鼠标左键，则两个位置之间的时间窗内的波形会被放大。

图幅的缩小通过键入``\texttt{o}''来实现，``\texttt{o}''最多可以回退5次绘图历史。

\subsection{同时标记三分量}
通常，震相在同一台站的三分量数据上具有相同的到时，因而将同一台站的三分量数据
画在一张图上，一方面可以综合三分量的波形信息以更准确地识别震相，另一方面，
一次标定三分量的震相到时可以减少工作量并保证震相在三分量上的到时相同。
使用命令``\texttt{ppk p 3 r m}''进入ppk模式即可每次只显示并同时标记三个波形数据。

通常在拾取震相时会一次性读入多个台站的波形数据，而``\texttt{ppk p 3 r m}''一次
只能显示三个波形数据，可以在ppk模式下不断键入``\texttt{n}''以依次显示接下来的
三个波形，也可以键入``\texttt{b}''以显示前三个波形。当不断键入``\texttt{n}''直到
所有波形数据都显示完毕的时候，会自动退出ppk模式。

\begin{SACCode}
SAC> dg sub teleseis ntkl.[nez] nykl.[nez] onkl.[nez] sdkl.[nez]
SAC> ppk p 3 r m
// 键入"t0"标记ntkl台站的三分量到时
// 键入"n"以绘制接下来的三个数据
// 键入"t0"标记nykl台站的三分量到时
// 键入"n"以绘制接下来的三个数据
// 键入"b"以绘制之前的三个数据
// 键入"t0"重新标记nykl台站的三分量到时
// 键入"n"以绘制接下来的三个数据
// 键入"t0"标记onkl台站的三分量到时
// 键入"n"以绘制接下来的三个数据
// 键入"t0"标记sdkl台站的三分量到时
// 键入"n"自动退出ppk模式
SAC> wh
SAC> q
\end{SACCode}

严格地说，\texttt{ppk p 3 r m} 的作用是一次显示内存中的三个波形数据，并同时标记
这三个波形数据的震相到时。当且仅当，每次显示的三个波形数据恰好是同一台站的
三分量数据时，该命令才能用作同时标记同一台站的三个分量。

要使得每次显示的恰好是同一台站的三分量波形数据，则要求同一台站的三个分量在内存
中分别位于第$n$、$n+1$和$n+2$位，其中n为正整数。通常情况下，一次性读入全部数据
的时候，都可以满足这一要求。但也有一些例外：
\begin{itemize}
\item 数据文件名比较奇葩，导致读入时同一台站的三分量数据不是紧挨着读入的，可以
    使用``\texttt{ls *.SAC}''命令检查文件的读入顺序；
\item 某个台站丢失了一个分量的数据，导致后面的所有台站都出现问题；
\end{itemize}

\subsection{ppk命令}
除了上面介绍的若干ppk命令之外，还有很多其他ppk命令。表 \ref{table:plotpk-commands} 列出
了ppk模式下的所有命令，
其中常用的命令包括``\texttt{b}''、``\texttt{l}''、``\texttt{n}''、``\texttt{o}''、
``\texttt{q}''、``\texttt{t}''和``\texttt{x}''。

\begin{center}
\small\ttfamily
\begin{longtable}{cll}
\multicolumn{3}{r}{接上页} \\
\toprule
命令    &   含义    &   说明    \\
\midrule
\endhead
\caption{ppk模式命令一览表} \label{table:plotpk-commands}   \\
\toprule
命令    &   含义    &   说明    \\
\midrule
\endfirsthead
\bottomrule
\multicolumn{3}{r}{接下页\dots} \\
\endfoot
\bottomrule
\endlastfoot

a	    &	定义事件初至a                           &   1,7	    \\
b	    &	如果有，则显示上一张绘图	            &           \\
c	    &	计算事件的初至和结束                    &   1,4,7	\\
d	    &	设置震相方向为DOWN	                    &           \\
e     	&	设置震相起始为EMERGENT(急始)	        &           \\
f	    &	定义事件结束f                           &  1,2,3,7	\\
g	    &	以HYPO格式将拾取显示到终端              &   4   	\\
h   	&	将拾取写成HYPO格式                      &   3,4 	\\
i	    &	设置震相起始为IMPULSIVE	                &           \\
j	    &	设置噪声水平                            &   2,6,8	\\
k       &   即kill，退出ppk模式                     &           \\
l	    &	显示光标当前位置                        &   2,4	    \\
m	    &	计算最大振幅波形                        &   2,3,5	\\
n	    &	显示下一绘图	                        &           \\
o	    &	显示前一个绘图窗，最多可以保存5个绘图窗	&           \\
p	    &	定义P波到时                             &   1,2,3,7	\\
q	    &	即quit，退出ppk模式	                            &           \\
s	    &	定义S波到时                             &   1,2,3,7 \\
t	    &	用户自定义到时tn，输入t之后需要输入0到9中的任一数	&   1,2,7\\
u	    &	设置震相方向为UP	                    &           \\
v	    &	定义一个Wood-Anderson波形               &   2,5 	\\
w	    &	定义一个通用波形                        &   2,5 	\\
x	    &	使用一个新的x轴时间窗，简单说就是放大。 &           \\
z	    &	设置参考水平                            &   2,6,8	\\
\textbackslash	    &	删除当前全部拾取的定义。当一个文件中包含多个事件时有用。&	\\
+	    &	设置震相方向为PLUS	                    &           \\
-	    &	设置震相方向为MINUS	                    &           \\
\lstinline[showspaces]! !   &	设置震相方向为NEUTRAL	                &           \\
n	    &	设置震相质量为n，n取0-4	                &           \\
\end{longtable}
\end{center}

注意：ppk模式的命令几乎都是由单个字符组成的，比如退出``\texttt{q}''，
唯一的例外是命令``\texttt{t}''，由字符``\texttt{t}''和0--9的整数构成。

不同的命令效果可能不同，有些会在绘图窗口显示信息，有些会将信息写入头段变量，
下面对表 \ref{table:plotpk-commands} 中的说明进行一个说明：
\begin{description}
    \item [1] 会将信息写入头段变量
    \item [2] 写入字符型震相拾取文件(若已打开)
    \item [3] 写入HYPO格式震相拾取文件(若已打开)
    \item [4] 在绘图窗口中显示信息
    \item [5] 窗口显示包含波形的矩形
    \item [6] 在指定的水平处放置水平光标
    \item [7] 绘图窗口显示含有到时标识的垂直线
    \item [8] 绘图窗口显示含有标识的水平线
\end{description}
